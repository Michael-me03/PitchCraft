#!/bin/bash
# ============================================================================
# PitchCraft.app — Standalone macOS Launcher
# Starts the bundled FastAPI backend (no Docker required).
# The backend also serves the pre-built React frontend at the same port.
# ============================================================================

CONTENTS="$(cd "$(dirname "$0")/.." && pwd)"
RESOURCES="$CONTENTS/Resources"
PYTHON="$RESOURCES/venv/bin/python3"
BACKEND="$RESOURCES/backend"
PORT=8765

# API key stored securely in user home — never inside the .app bundle
CONFIG_DIR="$HOME/.pitchcraft"
KEY_FILE="$CONFIG_DIR/api_key"
mkdir -p "$CONFIG_DIR"

notify() {
    osascript -e "display notification \"$1\" with title \"PitchCraft\" ${2:+subtitle \"$2\"}" 2>/dev/null || true
}

# ── Already running? Just open the browser ───────────────────────────────────
if curl -sf "http://127.0.0.1:$PORT/api/health" &>/dev/null; then
    open "http://127.0.0.1:$PORT"
    exit 0
fi

# ── Find API key: auto-detect from .env, then ask only if needed ──────────────
API_KEY=""

# 1. Check saved key from previous launch
if [ -s "$KEY_FILE" ]; then
    API_KEY="$(cat "$KEY_FILE")"
fi

# 2. Auto-detect from backend/.env (no copy-paste needed)
if [ -z "$API_KEY" ]; then
    for ENV_PATH in "$BACKEND/.env" "$CONTENTS/../../../backend/.env"; do
        if [ -f "$ENV_PATH" ]; then
            FOUND=$(grep -oP 'OPENAI_API_KEY\s*=\s*\K.+' "$ENV_PATH" 2>/dev/null \
                 || sed -n 's/^OPENAI_API_KEY\s*=\s*//p' "$ENV_PATH" 2>/dev/null)
            FOUND="$(echo "$FOUND" | tr -d '[:space:]')"
            if [ -n "$FOUND" ] && [ "$FOUND" != "sk-your-api-key-here" ]; then
                API_KEY="$FOUND"
                printf '%s' "$API_KEY" > "$KEY_FILE"
                chmod 600 "$KEY_FILE"
                notify "API key loaded from .env"
                break
            fi
        fi
    done
fi

# 3. Last resort: ask the user
if [ -z "$API_KEY" ]; then
    API_KEY=$(osascript 2>/dev/null <<'APPLESCRIPT'
set r to display dialog "Welcome to PitchCraft!" & return & return & "Enter your OpenAI API Key to get started:" default answer "" buttons {"Cancel", "Continue"} default button "Continue" with title "PitchCraft" with icon note
if button returned of r is "Cancel" then return ""
return text returned of r
APPLESCRIPT
)
    [[ -z "$API_KEY" ]] && exit 0
    printf '%s' "$API_KEY" > "$KEY_FILE"
    chmod 600 "$KEY_FILE"
    notify "API key saved" "Starting PitchCraft..."
fi

# ── Verify bundled Python exists ─────────────────────────────────────────────
if [ ! -x "$PYTHON" ]; then
    osascript -e 'display dialog "PitchCraft installation is incomplete.\n\nPlease run build_app.sh to rebuild the app." buttons {"OK"} default button "OK" with icon stop with title "PitchCraft"' 2>/dev/null
    exit 1
fi

# ── Start backend ─────────────────────────────────────────────────────────────
notify "Starting PitchCraft..."

export OPENAI_API_KEY="$(cat "$KEY_FILE")"
cd "$BACKEND"

"$PYTHON" -m uvicorn main:app \
    --host 127.0.0.1 \
    --port "$PORT" \
    --log-level warning \
    >> "$CONFIG_DIR/pitchcraft.log" 2>&1 &

BACKEND_PID=$!
echo "$BACKEND_PID" > "$CONFIG_DIR/backend.pid"

# ── Wait for backend health check ────────────────────────────────────────────
for i in $(seq 1 60); do
    sleep 1
    curl -sf "http://127.0.0.1:$PORT/api/health" &>/dev/null && break
    if [ "$i" -eq 60 ]; then
        osascript -e 'display dialog "PitchCraft could not start.\n\nCheck ~/pitchcraft/pitchcraft.log for details." buttons {"OK"} default button "OK" with icon stop with title "PitchCraft"' 2>/dev/null
        kill "$BACKEND_PID" 2>/dev/null
        exit 1
    fi
done

# ── Open in browser ───────────────────────────────────────────────────────────
open "http://127.0.0.1:$PORT"
notify "PitchCraft is ready!" "Opened in your browser"

# Keep process alive (closing the app stops the server)
trap "kill '$BACKEND_PID' 2>/dev/null; rm -f '$CONFIG_DIR/backend.pid'" EXIT
wait "$BACKEND_PID"
